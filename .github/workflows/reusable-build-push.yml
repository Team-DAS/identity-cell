name: 1. Plantilla de Build y Push a GHCR

# --- Disparador ---
# Se activa solo cuando es "llamado" por otro workflow
on:
  workflow_call:
    inputs:
      # Parámetro 1: El nombre de la imagen (ej: "auth-service")
      service-name:
        required: true
        type: string
      # Parámetro 2: La ruta a la carpeta del microservicio (ej: "./servicio-autenticacion")
      service-path:
        required: true
        type: string

# --- Permisos ---
# Necesitamos permisos para leer el código y escribir en el "Packages" (GHCR)
permissions:
  contents: read
  packages: write

jobs:
  build-and-push-ghcr:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout del código del monorepo
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      # 2. Login a GitHub Container Registry (ghcr.io)
      - name: Login a GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          # El 'username' es el dueño del repo (tu usuario u organización)
          username: ${{ github.repository_owner }}
          # El 'password' es el token automático de la Action, ¡muy seguro!
          password: ${{ secrets.GITHUB_TOKEN }}

      # 3. Preparar metadatos (nombre de imagen y tags)
      - name: Preparar metadatos de Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          # Formato de la imagen: ghcr.io/TU_USUARIO/TU_REPO/NOMBRE_SERVICIO
          images: ghcr.io/${{ github.repository }}/${{ inputs.service-name }}
          # Tags que vamos a crear:
          # - "latest" (para la rama main)
          # - El SHA del commit (ej: 1234abc) para trazabilidad
          tags: |
            type=sha,priority=200
            type=raw,value=latest,enable={{is_default_branch}}

      # 4. Construir y Publicar la imagen
      # Esto lee tu Dockerfile (con el builder incluido) y lo ejecuta
      - name: Construir y Publicar en GHCR
        uses: docker/build-push-action@v5
        with:
          # Contexto: la carpeta del microservicio
          context: ${{ inputs.service-path }}
          # Archivo: El Dockerfile dentro de esa carpeta
          file: ${{ inputs.service-path }}/Dockerfile
          # Indicar que queremos "publicar" la imagen
          push: true
          # Usar los tags que generamos en el paso anterior
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Habilitar caché de build de Docker para acelerar ejecuciones futuras
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Resumen de la imagen
        run: |
          echo "✅ Imagen publicada exitosamente:"
          echo "   ${{ steps.meta.outputs.tags }}"